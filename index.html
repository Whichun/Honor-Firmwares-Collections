<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Honor Firmwares Collections — 文件浏览器</title>
  <style>
    :root{--bg:#ffffff;--muted:#9aa0a6;--accent:#3b82f6;--row:#fbfdff}
    html,body{height:100%;margin:0;font-family:Inter, "Helvetica Neue", Arial, sans-serif;background:var(--bg);color:#1f2937}
    .container{max-width:1100px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:18px;margin:0}
    .search{display:flex;gap:8px;align-items:center}
    input[type=search]{padding:8px 12px;border-radius:8px;border:1px solid #e6e9ee;width:320px}
    .breadcrumb{color:var(--muted);font-size:13px;margin-bottom:8px}

    .table{border-radius:10px;overflow:hidden;border:1px solid #eef2f7}
    .table .thead{display:grid;grid-template-columns:40px 1fr 160px 100px;padding:12px 14px;background:#fff}
    .thead .col-title{font-weight:600;color:#374151}

    .list{background:var(--row)}
    .row{display:grid;grid-template-columns:40px 1fr 160px 100px;padding:12px 14px;align-items:center;border-top:1px solid rgba(15,23,42,0.02)}
    .row:hover{background:#f7fbff}
    .name{display:flex;flex-direction:column;gap:6px}
    .name .line{display:flex;gap:10px;align-items:center}
    .name .icon{width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;border-radius:6px}
    .name a, .name button{color:#0f172a;text-decoration:none;font-weight:500;border:0;background:transparent;padding:0;font-size:14px}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .path{font-size:12px;color:#6b7280}

    .controls{display:flex;gap:8px;align-items:center}
    button.control{border:0;padding:8px 10px;border-radius:8px;background:#f1f5f9;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}

    .empty{padding:36px;text-align:center;color:var(--muted)}

    @media(max-width:720px){.container{padding:12px}.thead{display:none}.row{grid-template-columns:1fr}.row .meta{margin-top:6px;display:flex;justify-content:space-between}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Honor Firmwares Collections</h1>
        <div class="breadcrumb" id="breadcrumb">全部文件 &gt; 12.1 &gt; 12.1.1</div>
      </div>
      <div class="search">
        <input id="q" type="search" placeholder="搜索文件或文件夹（回车）——支持全仓库搜索" />
        <div class="controls">
          <button id="refresh" class="control">刷新</button>
          <button id="home" class="control">回到根目录</button>
          <button id="clear" class="control">清除搜索</button>
        </div>
      </div>
    </header>

    <div class="table" role="table" aria-label="文件表">
      <div class="thead">
        <div></div>
        <div class="col-title">文件名称</div>
        <div class="col-title">修改时间</div>
        <div class="col-title">大小</div>
      </div>
      <div class="list" id="list"></div>
    </div>

    <div id="empty" class="empty" style="display:none">此目录为空</div>

  </div>

  <script>
  const listEl = document.getElementById('list');
  const breadcrumbEl = document.getElementById('breadcrumb');
  const emptyEl = document.getElementById('empty');
  const qEl = document.getElementById('q');

  let FILES_DATA = null;
  let pathStack = [];

  async function loadData(){
    try{
      const res = await fetch('./files.json', {cache: 'no-store'});
      if(!res.ok) throw new Error('files.json 未找到');
      FILES_DATA = await res.json();
      renderCurrent();
    }catch(e){
      listEl.innerHTML = `<div style="padding:20px;color:#b91c1c">无法加载 files.json：${e.message}</div>`;
    }
  }

  function getNodeAtPath(stack){
    let node = {type:'folder', children: FILES_DATA};
    for(const p of stack){
      if(!node.children) return null;
      node = node.children.find(it => it.type==='folder' && it.name===p);
      if(!node) return null;
    }
    return node;
  }

  function fmtSize(s){
    if(!s && s!==0) return '';
    const n = Number(s);
    if(isNaN(n)) return s;
    const KB = 1024;
    const MB = KB * 1024;
    const GB = MB * 1024;
    if(n>=GB) return (n/GB).toFixed(2)+' GB';
    if(n>=MB) return (n/MB).toFixed(2)+' MB';
    if(n>=KB) return (n/KB).toFixed(2)+' KB';
    return n+' B';
  }

  function renderBreadcrumb(){
    if(pathStack.length===0){
      breadcrumbEl.textContent = '全部文件';
      return;
    }
    const crumbs = ['全部文件', ...pathStack];
    breadcrumbEl.innerHTML = crumbs.map((c,i)=> i===crumbs.length-1 ? `<span>${escapeHtml(c)}</span>` : `<a href="#" data-i="${i}" class="bc">${escapeHtml(c)}</a>`).join(' &gt; ');
    document.querySelectorAll('.bc').forEach(a=> a.addEventListener('click', (e)=>{
      e.preventDefault();
      const idx = Number(a.dataset.i);
      pathStack = pathStack.slice(0, idx);
      renderCurrent();
    }));
  }

  function getFileTypeTag(filename){
    if(!filename) return 'default';
    const idx = filename.lastIndexOf('.');
    if(idx===-1) return 'default';
    const ext = filename.slice(idx+1).toLowerCase();
    if(['zip','7z','rar'].includes(ext)) return 'zip';
    if(['apk'].includes(ext)) return 'android';
    if(['exe','msi'].includes(ext)) return 'pc';
    return 'default';
  }

  // 扁平化整个文件树，返回每个节点并包含其完整路径（数组）
  function flattenTree(){
    const out = [];
    function walk(children, parentPath){
      if(!Array.isArray(children)) return;
      for(const it of children){
        const curPath = parentPath.slice();
        if(it.type==='folder'){
          curPath.push(it.name);
          out.push({type:'folder', name: it.name, mtime: it.mtime || '', size: '', path: curPath.slice(), node: it});
          walk(it.children, curPath);
        } else {
          out.push({type:'file', name: it.name, mtime: it.mtime||'', size: it.size||0, link: it.link||'', path: parentPath.slice(), node: it});
        }
      }
    }
    walk(FILES_DATA, []);
    return out;
  }

  function searchAll(q){
    const flat = flattenTree();
    const key = q.toLowerCase();
    return flat.filter(it => it.name.toLowerCase().includes(key));
  }

  function renderCurrent(){
    const q = (qEl.value || '').trim();
    if(q){
      renderSearchResults(q);
      return;
    }

    renderBreadcrumb();
    const node = getNodeAtPath(pathStack);
    if(!node){ listEl.innerHTML = '<div style="padding:20px;color:#b91c1c">找不到该目录</div>'; return; }
    const children = Array.isArray(node.children) ? node.children : [];
    const visible = children.slice();
    if(visible.length===0){ listEl.innerHTML=''; emptyEl.style.display='block'; return; } else emptyEl.style.display='none';

    visible.sort((a,b)=>{ if(a.type===b.type) return a.name.localeCompare(b.name, 'zh'); return a.type==='folder'? -1:1; });

    listEl.innerHTML = visible.map(it=>{
      const iconType = it.type==='folder' ? 'folder' : getFileTypeTag(it.name);
      const mtime = it.mtime || '';
      const size = it.type==='file' ? fmtSize(it.size) : '';
      const nameHtml = it.type==='folder'
        ? `<button class="open-folder" data-name="${escapeHtml(it.name)}">${escapeHtml(it.name)}</button>`
        : `<a href="${escapeHtml(it.link||'#')}" data-link="${escapeHtml(it.link||'')}" ${it.link? 'target="_blank" rel="noopener"':''}>${escapeHtml(it.name)}</a>`;

      return `<div class="row" data-type="${iconType}">
        <div><div class="icon">${iconHtml(iconType)}</div></div>
        <div class="name"><div class="line">${nameHtml}</div></div>
        <div class="muted">${mtime}</div>
        <div class="small">${size}</div>
      </div>`;
    }).join('');

    document.querySelectorAll('.open-folder').forEach(btn=> btn.addEventListener('click', (e)=>{ const nm = btn.dataset.name; pathStack.push(nm); renderCurrent(); }));
  }

  function renderSearchResults(q){
    renderBreadcrumb();
    const results = searchAll(q);
    if(results.length===0){ listEl.innerHTML=''; emptyEl.style.display='block'; emptyEl.textContent = `未找到匹配 "${q}" 的文件或文件夹`; return; } else { emptyEl.style.display='none'; emptyEl.textContent = '此目录为空'; }
    results.sort((a,b)=>{ if(a.type===b.type) return a.name.localeCompare(b.name, 'zh'); return a.type==='folder'? -1:1; });

    listEl.innerHTML = results.map(it=>{
      const iconType = it.type==='folder' ? 'folder' : getFileTypeTag(it.name);
      const mtime = it.mtime || '';
      const size = it.type==='file' ? fmtSize(it.size) : '';
      const displayPath = it.path.length? it.path.join(' / '): '';

      const nameHtml = it.type==='folder'
        ? `<button class="open-folder-search" data-path='${escapeHtml(JSON.stringify(it.path))}'>${escapeHtml(it.name)}</button>`
        : `<a href="${escapeHtml(it.link||'#')}" data-link="${escapeHtml(it.link||'')}" ${it.link? 'target="_blank" rel="noopener"':''}>${escapeHtml(it.name)}</a>`;

      return `<div class="row" data-type="${iconType}">
        <div><div class="icon">${iconHtml(iconType)}</div></div>
        <div class="name"><div class="line">${nameHtml}</div><div class="path">${escapeHtml(displayPath)}</div></div>
        <div class="muted">${mtime}</div>
        <div class="small">${size}</div>
      </div>`;
    }).join('');

    document.querySelectorAll('.open-folder-search').forEach(btn=> btn.addEventListener('click', ()=>{
      try{ const p = JSON.parse(btn.dataset.path); pathStack = p; qEl.value = ''; renderCurrent(); }catch(e){ console.error(e); }
    }));
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

  // 读取仓库 icon/ 文件夹中的 svg 作为图标。文件夹图标保持内联 svg。
  function iconHtml(type){
    if(type==='folder') return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 7a2 2 0 012-2h4l2 2h8a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V7z" fill="#E0F2FE"/><path d="M3 7a2 2 0 012-2h4l2 2h8a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V7z" stroke="#7dd3fc" stroke-width="0.5" fill-opacity="0"/></svg>`;
    const mapping = { zip: 'zip.svg', pc: 'pc.svg', android: 'android.svg', default: 'default.svg' };
    const fname = mapping[type] || 'default.svg';
    return `<img src="./icon/${fname}" alt="${fname}" width="18" height="18" onerror="this.onerror=null;this.src='./icon/default.svg'" style="display:block" />`;
  }

  document.getElementById('refresh').addEventListener('click', ()=> loadData());
  document.getElementById('home').addEventListener('click', ()=>{ pathStack = []; qEl.value=''; renderCurrent(); });
  document.getElementById('clear').addEventListener('click', ()=>{ qEl.value=''; pathStack=[]; renderCurrent(); });
  qEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') renderCurrent(); });

  loadData();
  </script>
</body>
</html>
